<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEXUS-KERNEL Strategic Dashboard</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    :root{
      /* Quantum Obsidian Brand Colors */
      --color-primary: #3730a3;        /* Deep Indigo 600 */
      --color-primary-light: #4f46e5;  /* Indigo 500 */
      --color-accent: #06b6d4;         /* Electric Cyan 500 */
      --color-success: #10b981;
      --color-warning: #f59e0b;
      --color-danger: #ef4444;
      --color-surface-well: #f8f9fa;
      --color-white: #ffffff;
      --color-border: #e5e7eb;
      
      --ink:#111111;
      --muted:#6b7280;
      --rule:#111111;
      --hair:#d1d5db;
      --page-pad-y: 48px;
      --page-pad-x: 56px;
      --gap-1: 8px;
      --gap-2: 16px;
      --gap-3: 24px;
      --gap-4: 32px;
      --gap-5: 40px;
      --gap-6: 48px;
      --radius-sm: 4px;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Inter, Roboto, Arial, sans-serif;
    }

    html, body { height: 100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--ink);
      background:#f5f5f5;
      line-height: 1.55;
      -webkit-font-smoothing: antialiased;
    }

    /* Dashboard container */
    .dashboard{
      max-width: 90rem;
      margin: 0 auto;
      background: white;
    }

    .section{
      padding: var(--page-pad-y) var(--page-pad-x);
      border-bottom: 1px solid var(--hair);
    }
    .section:last-child{ border-bottom: none; }

    /* Header */
    .dashboard-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: var(--gap-4);
      padding-bottom: 12px;
      margin-bottom: var(--gap-5);
      border-bottom: 3px solid var(--color-primary);
    }
    .dashboard-title{
      font-size: 36px;
      font-weight: 800;
      letter-spacing: -0.02em;
      margin:0;
      color: var(--color-primary);
    }
    .dashboard-meta{
      text-align: right;
    }
    .dashboard-date{
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 var(--gap-1) 0;
    }
    .dashboard-status{
      font-size: 12px;
      padding: 4px 12px;
      background: var(--color-success);
      color: white;
      border-radius: 12px;
      font-weight: 600;
      display: inline-block;
    }

    /* Section titles */
    .section-title{
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 var(--gap-4) 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--hair);
      letter-spacing: -0.015em;
    }

    .subsection-title{
      font-size: 16px;
      font-weight: 700;
      margin: var(--gap-4) 0 var(--gap-2) 0;
      color: var(--color-primary);
    }

    /* Executive recommendation - Governing Thought Header */
    .exec-recommendation{
      border-left: 4px solid var(--color-primary);
      padding: var(--gap-3);
      background: linear-gradient(to right, var(--color-surface-well), transparent);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      margin-bottom: var(--gap-4);
    }
    .kicker{
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--color-primary);
      margin: 0 0 var(--gap-1) 0;
      font-weight: 800;
    }
    .lead{
      font-size: 18px;
      font-weight: 600;
      margin:0;
      line-height: 1.5;
    }

    /* Obsidian Shards */
    .insight-rail{
      display:grid;
      gap: 18px;
      margin-top: var(--gap-3);
    }
    .insight-row{
      display:grid;
      grid-template-columns: 24px 1fr;
      gap: var(--gap-2);
      align-items: start;
    }
    .insight-shard{
      width: 14px;
      height: 14px;
      background: var(--color-primary);
      transform: rotate(45deg);
      margin-top: 6px;
      box-shadow: 0 0 0 2px var(--color-white), 0 0 0 3px var(--color-border);
      flex-shrink: 0;
    }

    /* Harvey Ball Scoring Matrix */
    .harvey {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--ink);
      display: inline-block;
      vertical-align: middle;
      margin: 0 auto;
    }
    .harvey-0   { background: transparent; }
    .harvey-25  { background: conic-gradient(var(--color-primary) 25%, transparent 0); border-color: var(--color-primary); }
    .harvey-50  { background: conic-gradient(var(--color-primary) 50%, transparent 0); border-color: var(--color-primary); }
    .harvey-75  { background: conic-gradient(var(--color-primary) 75%, transparent 0); border-color: var(--color-primary); }
    .harvey-100 { background: var(--color-primary); border-color: var(--color-primary); }

    /* KPI Cards */
    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--gap-3);
      margin: var(--gap-4) 0;
    }
    .kpi-card{
      background: var(--color-surface-well);
      padding: var(--gap-3);
      border-radius: var(--radius-sm);
      border-left: 4px solid var(--color-primary);
      transition: transform 0.2s;
    }
    .kpi-card:hover{
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .kpi-label{
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin: 0 0 var(--gap-1) 0;
      font-weight: 600;
    }
    .kpi-value{
      font-size: 32px;
      font-weight: 800;
      margin: 0;
      color: var(--color-primary);
    }
    .kpi-trend{
      font-size: 13px;
      margin-top: var(--gap-1);
      color: var(--muted);
    }
    .kpi-trend.positive{ color: var(--color-success); }
    .kpi-trend.negative{ color: var(--color-danger); }

    /* Tables */
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 14px;
      margin: var(--gap-3) 0;
    }
    thead th{
      text-align:left;
      font-size: 12px;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: var(--muted);
      padding: 12px 12px;
      border-bottom: 2px solid var(--hair);
      font-weight: 700;
    }
    tbody td{
      padding: 14px 12px;
      border-bottom: 1px solid var(--hair);
      vertical-align: top;
    }
    tbody tr:hover{
      background: var(--color-surface-well);
    }
    tbody tr:last-child td{ border-bottom: none; }
    .text-center{ text-align: center; }
    .text-right{ text-align: right; }

    /* Status badges */
    .badge{
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .badge-success{ background: #d1fae5; color: #065f46; }
    .badge-warning{ background: #fef3c7; color: #92400e; }
    .badge-danger{ background: #fee2e2; color: #991b1b; }
    .badge-info{ background: #dbeafe; color: #1e40af; }

    /* Editable sections */
    .editable-section{
      position: relative;
      padding: var(--gap-3);
      border: 2px dashed transparent;
      border-radius: var(--radius-sm);
      transition: all 0.2s;
    }
    .editable-section:hover{
      border-color: var(--color-primary);
      background: var(--color-surface-well);
    }
    .edit-btn{
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 6px 12px;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .editable-section:hover .edit-btn{
      opacity: 1;
    }
    .edit-btn:hover{
      background: var(--color-primary-light);
    }

    /* Modal */
    .modal{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: var(--gap-4);
    }
    .modal.active{
      display: flex;
    }
    .modal-content{
      background: white;
      padding: var(--gap-5);
      border-radius: var(--radius-sm);
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    .modal-title{
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 var(--gap-3) 0;
      color: var(--color-primary);
    }
    .modal-textarea{
      width: 100%;
      min-height: 200px;
      padding: var(--gap-2);
      border: 2px solid var(--hair);
      border-radius: var(--radius-sm);
      font-family: var(--font);
      font-size: 14px;
      resize: vertical;
    }
    .modal-textarea:focus{
      outline: none;
      border-color: var(--color-primary);
    }
    .modal-actions{
      display: flex;
      gap: var(--gap-2);
      margin-top: var(--gap-3);
      justify-content: flex-end;
    }
    .btn{
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary{
      background: var(--color-primary);
      color: white;
    }
    .btn-primary:hover{
      background: var(--color-primary-light);
    }
    .btn-secondary{
      background: var(--color-surface-well);
      color: var(--ink);
    }
    .btn-secondary:hover{
      background: var(--hair);
    }

    /* Action bar */
    .action-bar{
      position: fixed;
      bottom: var(--gap-4);
      right: var(--gap-4);
      display: flex;
      gap: var(--gap-2);
      z-index: 100;
    }
    .action-btn{
      padding: 12px 20px;
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(55, 48, 163, 0.3);
      transition: all 0.2s;
    }
    .action-btn:hover{
      background: var(--color-primary-light);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(55, 48, 163, 0.4);
    }

    /* Progress bars */
    .progress-bar{
      height: 24px;
      background: var(--color-surface-well);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill{
      height: 100%;
      background: var(--color-primary);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 12px;
      color: white;
      font-size: 12px;
      font-weight: 700;
      transition: width 0.3s;
    }
    .progress-fill.success{ background: var(--color-success); }
    .progress-fill.warning{ background: var(--color-warning); }
    .progress-fill.danger{ background: var(--color-danger); }

    @media (max-width: 860px){
      .section{ padding: var(--gap-4) var(--gap-3); }
      .dashboard-header{ flex-direction: column; }
      .dashboard-meta{ text-align: left; }
    }
  </style>
</head>
<body>
  <div class="dashboard">

    <!-- HEADER -->
    <section class="section">
      <div class="dashboard-header">
        <div>
          <h1 class="dashboard-title">NEXUS-KERNEL</h1>
          <p style="margin: 8px 0 0 0; color: var(--muted); font-size: 14px;">Strategic Status Dashboard</p>
        </div>
        <div class="dashboard-meta">
          <p class="dashboard-date" id="current-date">January 4, 2026</p>
          <span class="dashboard-status">ACTIVE</span>
        </div>
      </div>

      <div class="exec-recommendation editable-section" data-section="executive-summary">
        <button class="edit-btn" onclick="openEditModal('executive-summary')">Edit</button>
        <p class="kicker">Executive Summary</p>
        <p class="lead" id="executive-summary-content">
          NEXUS-KERNEL is an industrial-grade ERP kernel with 699 semantic design classes, 12 pre-built templates, and comprehensive validation schemas. The system maintains 85% completion with critical gaps in payment integrations and multi-currency support.
        </p>
      </div>

      <!-- KPI Grid -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <p class="kpi-label">Total Templates</p>
          <p class="kpi-value" id="kpi-templates">12</p>
          <p class="kpi-trend">Core, Finance, Sales, HR</p>
        </div>
        <div class="kpi-card">
          <p class="kpi-label">Design Classes</p>
          <p class="kpi-value" id="kpi-classes">699</p>
          <p class="kpi-trend positive">+120 from baseline</p>
        </div>
        <div class="kpi-card">
          <p class="kpi-label">Completion Rate</p>
          <p class="kpi-value" id="kpi-completion">85%</p>
          <p class="kpi-trend">Production-ready</p>
        </div>
        <div class="kpi-card">
          <p class="kpi-label">Critical Gaps</p>
          <p class="kpi-value" id="kpi-gaps">4</p>
          <p class="kpi-trend negative">Requires attention</p>
        </div>
      </div>
    </section>

    <!-- CURRENT STATE -->
    <section class="section">
      <h2 class="section-title">What Is Now</h2>

      <div class="subsection-title">‚úì Completed Components</div>
      <div class="insight-rail">
        <div class="insight-row">
          <div class="insight-shard"></div>
          <div><strong>Quantum Obsidian Design System:</strong> 699 semantic classes (P1-P10 pillars), 80.76 KB minified CSS, zero arbitrary values, 5 responsive breakpoints</div>
        </div>
        <div class="insight-row">
          <div class="insight-shard"></div>
          <div><strong>Template Library:</strong> 12 production-ready templates (Core, Finance, Sales, Purchase, Inventory, HR, Manufacturing, Warehouse, Project, Compliance, Asset, Admin)</div>
        </div>
        <div class="insight-row">
          <div class="insight-shard"></div>
          <div><strong>Validation Framework:</strong> Zod schemas for all templates, comprehensive type safety, error boundaries with fallbacks</div>
        </div>
        <div class="insight-row">
          <div class="insight-shard"></div>
          <div><strong>Data Standards:</strong> ISO 3166-1 countries, ISO 4217 currencies, ISO 639-1 languages, ERPNext chart of accounts integration</div>
        </div>
      </div>

      <div class="subsection-title">üìä System Health Metrics</div>
      <table>
        <thead>
          <tr>
            <th>Component</th>
            <th>Status</th>
            <th class="text-center">Coverage</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Design System</td>
            <td><span class="badge badge-success">Complete</span></td>
            <td class="text-center">
              <div class="progress-bar">
                <div class="progress-fill success" style="width: 100%">100%</div>
              </div>
            </td>
            <td>All 10 pillars implemented</td>
          </tr>
          <tr>
            <td>Core Templates</td>
            <td><span class="badge badge-success">Complete</span></td>
            <td class="text-center">
              <div class="progress-bar">
                <div class="progress-fill success" style="width: 100%">100%</div>
              </div>
            </td>
            <td>12/12 templates validated</td>
          </tr>
          <tr>
            <td>Finance Module</td>
            <td><span class="badge badge-warning">Partial</span></td>
            <td class="text-center">
              <div class="progress-bar">
                <div class="progress-fill warning" style="width: 75%">75%</div>
              </div>
            </td>
            <td>Missing payment gateways</td>
          </tr>
          <tr>
            <td>Multi-Currency</td>
            <td><span class="badge badge-danger">Gap</span></td>
            <td class="text-center">
              <div class="progress-bar">
                <div class="progress-fill danger" style="width: 40%">40%</div>
              </div>
            </td>
            <td>ISO 4217 data only, no conversion logic</td>
          </tr>
          <tr>
            <td>Documentation</td>
            <td><span class="badge badge-success">Complete</span></td>
            <td class="text-center">
              <div class="progress-bar">
                <div class="progress-fill success" style="width: 100%">100%</div>
              </div>
            </td>
            <td>PRDs, Canon, API docs</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- WHAT IS MISSING -->
    <section class="section">
      <h2 class="section-title">What Is Missing</h2>

      <div class="editable-section" data-section="critical-gaps">
        <button class="edit-btn" onclick="openEditModal('critical-gaps')">Edit</button>
        <div class="subsection-title">üî¥ Critical Gaps (P0)</div>
        <div id="critical-gaps-content">
          <table>
            <thead>
              <tr>
                <th>Gap</th>
                <th class="text-center">Impact</th>
                <th>Mitigation</th>
                <th class="text-center">Priority</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Payment Gateway Integration</strong></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
                <td>Blocks real-world transactions, limits production deployment</td>
                <td class="text-center"><span class="badge badge-danger">P0</span></td>
              </tr>
              <tr>
                <td><strong>Multi-Currency Exchange Logic</strong></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
                <td>ISO data exists but no conversion engine, prevents global deployment</td>
                <td class="text-center"><span class="badge badge-danger">P0</span></td>
              </tr>
              <tr>
                <td><strong>Inventory Real-Time Sync</strong></td>
                <td class="text-center"><div class="harvey harvey-75"></div></td>
                <td>Template exists but lacks webhook/websocket integration</td>
                <td class="text-center"><span class="badge badge-warning">P1</span></td>
              </tr>
              <tr>
                <td><strong>Audit Trail System</strong></td>
                <td class="text-center"><div class="harvey harvey-50"></div></td>
                <td>No change tracking for compliance requirements (SOX, GDPR)</td>
                <td class="text-center"><span class="badge badge-warning">P1</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="editable-section" data-section="enhancement-backlog">
        <button class="edit-btn" onclick="openEditModal('enhancement-backlog')">Edit</button>
        <div class="subsection-title">üü° Enhancement Backlog (P2)</div>
        <div id="enhancement-backlog-content">
          <div class="insight-rail">
            <div class="insight-row">
              <div class="insight-shard"></div>
              <div><strong>Advanced Reporting:</strong> McKinsey-grade analytics dashboards, P&L statements, balance sheets, cash flow projections</div>
            </div>
            <div class="insight-row">
              <div class="insight-shard"></div>
              <div><strong>Mobile Responsiveness:</strong> Design system has 5 breakpoints but templates need mobile-first optimization</div>
            </div>
            <div class="insight-row">
              <div class="insight-shard"></div>
              <div><strong>Localization Engine:</strong> ISO 639-1 data exists but UI translation system not implemented</div>
            </div>
            <div class="insight-row">
              <div class="insight-shard"></div>
              <div><strong>API Documentation:</strong> TypeDoc generated but needs Swagger/OpenAPI spec for external integrations</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- STRATEGIC REMARKS -->
    <section class="section">
      <h2 class="section-title">Strategic Remarks</h2>

      <div class="editable-section" data-section="strategic-observations">
        <button class="edit-btn" onclick="openEditModal('strategic-observations')">Edit</button>
        <div class="subsection-title">üìå Key Observations</div>
        <div id="strategic-observations-content">
          <table>
            <thead>
              <tr>
                <th>Dimension</th>
                <th class="text-center">Authority</th>
                <th class="text-center">Enforceability</th>
                <th class="text-center">Scalability</th>
                <th class="text-center">Modernity</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Design System</strong></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
                <td class="text-center"><div class="harvey harvey-75"></div></td>
              </tr>
              <tr>
                <td><strong>Template Library</strong></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
                <td class="text-center"><div class="harvey harvey-75"></div></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
              </tr>
              <tr>
                <td><strong>Data Validation</strong></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
                <td class="text-center"><div class="harvey harvey-75"></div></td>
                <td class="text-center"><div class="harvey harvey-100"></div></td>
              </tr>
              <tr>
                <td><strong>Integration Layer</strong></td>
                <td class="text-center"><div class="harvey harvey-25"></div></td>
                <td class="text-center"><div class="harvey harvey-0"></div></td>
                <td class="text-center"><div class="harvey harvey-50"></div></td>
                <td class="text-center"><div class="harvey harvey-25"></div></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="editable-section" data-section="recommendations">
        <button class="edit-btn" onclick="openEditModal('recommendations')">Edit</button>
        <div class="subsection-title">üí° Recommendations</div>
        <div id="recommendations-content">
          <div class="insight-rail">
            <div class="insight-row">
              <div class="insight-shard"></div>
              <div><strong>Immediate (Week 1-2):</strong> Implement Stripe/PayPal payment gateway integration, basic currency conversion API</div>
            </div>
            <div class="insight-row">
              <div class="insight-shard"></div>
              <div><strong>Short-term (Month 1):</strong> Build audit trail system using Supabase RLS policies, add webhook endpoints for inventory sync</div>
            </div>
            <div class="insight-row">
              <div class="insight-shard"></div>
              <div><strong>Medium-term (Quarter 1):</strong> Develop mobile-first responsive templates, implement i18n with ISO 639-1 language packs</div>
            </div>
            <div class="insight-row">
              <div class="insight-shard"></div>
              <div><strong>Long-term (Year 1):</strong> Launch API marketplace, build AI-powered analytics, establish ecosystem partnerships</div>
            </div>
          </div>
        </div>
      </div>

      <div class="editable-section" data-section="technical-notes">
        <button class="edit-btn" onclick="openEditModal('technical-notes')">Edit</button>
        <div class="subsection-title">‚öôÔ∏è Technical Notes</div>
        <div id="technical-notes-content" style="font-size: 14px; line-height: 1.7; color: var(--muted);">
          <p><strong>CSS Architecture:</strong> Pure semantic classes with zero arbitrary values. All utilities locked to design tokens (P1-P10). 20% compression ratio (101.4 KB ‚Üí 80.76 KB). Competitive with industry standards (699 classes vs Supabase 450, Bootstrap 600).</p>
          <p><strong>Build Pipeline:</strong> PostCSS compilation (input.css ‚Üí style.css), TypeScript strict mode, Vitest for unit tests, TypeDoc for API documentation. Zero-dependency HTTP server for dashboard.</p>
          <p><strong>Data Integrity:</strong> Zod schema enforcement for all templates, comprehensive validation, error boundaries with fallbacks. 100% type-safe infrastructure.</p>
          <p><strong>Performance:</strong> In-memory caching with TTL (5s for dashboard, 5min for API), hot-swappable CSS (reload picks up changes), URL state persistence for deep linking.</p>
        </div>
      </div>
    </section>

  </div>

  <!-- Action Bar -->
  <div class="action-bar">
    <button class="action-btn" onclick="exportData()">üì• Export JSON</button>
    <button class="action-btn" onclick="saveToLocal()">üíæ Save to Local</button>
  </div>

  <!-- Edit Modal -->
  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <h3 class="modal-title" id="modal-title">Edit Section</h3>
      <textarea class="modal-textarea" id="modal-textarea"></textarea>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveEdit()">Save</button>
      </div>
    </div>
  </div>

  <script>
    // State management
    let currentSection = null;
    const storageKey = 'nexus-kernel-dashboard-data';

    // Security: HTML sanitization function
    function sanitizeHTML(str) {
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }

    // Security: Safe HTML parser (allows limited tags)
    function parseHTML(html) {
      const allowedTags = ['b', 'strong', 'i', 'em', 'u', 'br', 'p', 'ul', 'ol', 'li', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'div', 'span'];
      const temp = document.createElement('div');
      temp.innerHTML = html;
      
      // Remove scripts and event handlers
      temp.querySelectorAll('script, style, iframe, object, embed').forEach(el => el.remove());
      temp.querySelectorAll('*').forEach(el => {
        Array.from(el.attributes).forEach(attr => {
          if (attr.name.startsWith('on')) {
            el.removeAttribute(attr.name);
          }
        });
        if (!allowedTags.includes(el.tagName.toLowerCase())) {
          el.replaceWith(...el.childNodes);
        }
      });
      
      return temp.innerHTML;
    }

    // Load saved data on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadFromLocal();
      updateDate();
    });

    function updateDate() {
      const date = new Date().toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      document.getElementById('current-date').textContent = date;
    }

    function openEditModal(sectionId) {
      currentSection = sectionId;
      const contentEl = document.getElementById(`${sectionId}-content`);
      const modal = document.getElementById('edit-modal');
      const textarea = document.getElementById('modal-textarea');
      const title = document.getElementById('modal-title');

      // Get text content or innerHTML based on section
      if (sectionId === 'executive-summary') {
        textarea.value = contentEl.textContent.trim();
      } else {
        textarea.value = contentEl.innerHTML.trim();
      }

      title.textContent = `Edit: ${formatSectionTitle(sectionId)}`;
      modal.classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('edit-modal').classList.remove('active');
      currentSection = null;
    }

    function saveEdit() {
      if (!currentSection) return;

      const textarea = document.getElementById('modal-textarea');
      const contentEl = document.getElementById(`${currentSection}-content`);

      if (currentSection === 'executive-summary') {
        contentEl.textContent = textarea.value; // Safe - plain text only
      } else {
        // Security: Sanitize HTML before injection
        contentEl.innerHTML = parseHTML(textarea.value);
      }

      saveToLocal();
      closeEditModal();
    }

    function formatSectionTitle(id) {
      return id.split('-').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
    }

    function saveToLocal() {
      const data = {
        timestamp: new Date().toISOString(),
        sections: {}
      };

      // Save all editable sections
      const sections = [
        'executive-summary',
        'critical-gaps',
        'enhancement-backlog',
        'strategic-observations',
        'recommendations',
        'technical-notes'
      ];

      sections.forEach(section => {
        const contentEl = document.getElementById(`${section}-content`);
        if (contentEl) {
          data.sections[section] = section === 'executive-summary' 
            ? contentEl.textContent 
            : contentEl.innerHTML;
        }
      });

      // Save KPI values
      data.kpis = {
        templates: document.getElementById('kpi-templates').textContent,
        classes: document.getElementById('kpi-classes').textContent,
        completion: document.getElementById('kpi-completion').textContent,
        gaps: document.getElementById('kpi-gaps').textContent
      };

      localStorage.setItem(storageKey, JSON.stringify(data, null, 2));
      
      // Visual feedback
      const btn = event?.target;
      if (btn) {
        const originalText = btn.textContent;
        btn.textContent = '‚úì Saved!';
        btn.style.background = 'var(--color-success)';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
        }, 2000);
      }
    }

    function loadFromLocal() {
      const stored = localStorage.getItem(storageKey);
      if (!stored) return;

      try {
        const data = JSON.parse(stored);
 with sanitization
        Object.entries(data.sections || {}).forEach(([section, content]) => {
          const contentEl = document.getElementById(`${section}-content`);
          if (contentEl) {
            if (section === 'executive-summary') {
              contentEl.textContent = content; // Safe - plain text
            } else {
              // Security: Sanitize before rendering
              contentEl.innerHTML = parseHTML(content)
              contentEl.innerHTML = content;
            }
          }
        });

        // Load KPIs
        if (data.kpis) {
          Object.entries(data.kpis).forEach(([key, value]) => {
            const el = document.getElementById(`kpi-${key}`);
            if (el) el.textContent = value;
          });
        }

        console.log('‚úì Data loaded from local storage (saved:', data.timestamp + ')');
      } catch (e) {
        console.error('Failed to load from local storage:', e);
      }
    }

    function exportData() {
      const data = {
        export_date: new Date().toISOString(),
        kernel_status: {
          templates_count: document.getElementById('kpi-templates').textContent,
          design_classes: document.getElementById('kpi-classes').textContent,
          completion_rate: document.getElementById('kpi-completion').textContent,
          critical_gaps: document.getElementById('kpi-gaps').textContent
        },
        executive_summary: document.getElementById('executive-summary-content').textContent,
        sections: {}
      };

      // Export all editable sections
      ['critical-gaps', 'enhancement-backlog', 'strategic-observations', 'recommendations', 'technical-notes'].forEach(section => {
        const contentEl = document.getElementById(`${section}-content`);
        if (contentEl) {
          data.sections[section] = contentEl.textContent.trim();
        }
      });

      // Download as JSON
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `nexus-kernel-status-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Visual feedback
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚úì Exported!';
      btn.style.background = 'var(--color-success)';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    }

    // Close modal on background click
    document.getElementById('edit-modal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        closeEditModal();
      }
    });

    // Auto-save on visibility change
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        saveToLocal();
      }
    });
  </script>
</body>
</html>
