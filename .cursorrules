# NexusCanon VMP: IDE Rules & Standards

**Version:** 4.0.0 (Kernel Doctrine Aligned)  
**Context:** Node.js, Express, Nunjucks, HTMX, Supabase (Clean Stack)  
**Status:** Kernel Doctrine Compliance Enforced  
**Foundation:** [NEXUS_CANON_V5_KERNEL_DOCTRINE.md](docs/ssot/db/NEXUS_CANON_V5_KERNEL_DOCTRINE.md) (Absolute Authority)  
**Documentation Registry:** [DOCUMENTATION_REGISTRY.md](docs/DOCUMENTATION_REGISTRY.md) - All documentation organized in `docs/` structure

---

## 0. üèõÔ∏è Template & Pre-Seeding System (System-Defined Authority)

### 0.1 Core Principle ‚Äî Template-Based Development

> **We don't trust AI judgment. We don't trust human judgment. We trust properly defined templates and pre-seeded patterns.**

**CRITICAL RULE:** Before implementing ANY feature, the AI MUST:

1. **Check for existing template/pre-seed:**
   - Look in `src/views/templates/` for matching template
   - Look in `docs/development/templates/` for pre-seeded patterns
   - If template exists: Use it. No deviation.
   - If template doesn't exist: STOP. Request template creation first.

2. **Use pre-seeded layer assignments:**
   - **L0 (Kernel):** Defined in `src/kernel/templates/` - Concept Registry, Value Sets, Identity Mapping
   - **L1 (Domain):** Defined in `src/domains/templates/` - Policy engines, Permissions, RBAC
   - **L2 (Cluster):** Defined in `src/clusters/templates/` - Workflows, Approval chains, State machines
   - **L3 (Cell):** Defined in `src/views/templates/` - User interfaces, Execution actions, UI components

3. **Follow pre-defined priority templates:**
   - **P0 (Critical):** Template: `templates/p0-critical-template.js`
   - **P1 (High):** Template: `templates/p1-high-template.js`
   - **P2 (Medium):** Template: `templates/p2-medium-template.js`
   - **P3 (Low):** Template: `templates/p3-low-template.js`

### 0.2 Template Enforcement Rules

**Template-Based Development:**
- ‚úÖ All features MUST start from a template
- ‚úÖ Templates define structure, patterns, and constraints
- ‚úÖ No deviation from template structure without approval
- ‚úÖ Templates are versioned and immutable
- ‚ùå NO ad-hoc layer assignments
- ‚ùå NO manual priority decisions
- ‚ùå NO custom patterns without template

**Pre-Seeding Requirements:**
- ‚úÖ Known patterns pre-seeded in templates
- ‚úÖ Current state documented in templates
- ‚úÖ Coming soon features templated (inactive)
- ‚úÖ Potential issues documented in template comments
- ‚úÖ Experience-based patterns captured in templates

### 0.3 Template Compliance Checklist

Before ANY code generation, verify:

- [ ] **Template Check:** Does a template exist for this feature?
- [ ] **Pre-Seed Check:** Is this feature pre-seeded in templates?
- [ ] **Pattern Check:** Does this match an existing template pattern?
- [ ] **Structure Check:** Will this follow the template structure exactly?
- [ ] **Approval Check:** If no template exists, has template creation been approved?

**If ANY check fails, STOP and request template creation.**

---

## 1. üö® Prime Directives (CRITICAL)

* **Kernel Doctrine First:** All development MUST align with [NEXUS_CANON_V5_KERNEL_DOCTRINE.md](docs/ssot/db/NEXUS_CANON_V5_KERNEL_DOCTRINE.md). No exceptions.
* **Route-First Architecture:** Never create an HTML file without a corresponding route in `server.js`.
* **No Direct Access:** HTML files are **never** served statically. They must be rendered via `res.render()`.
* **Foundation vs. Design:** Use VMP semantic classes (`.vmp-h*`, `.vmp-body`, `.vmp-label`) for typography **ONLY in data presentation contexts**. Inline styles and `<style>` blocks **ALLOWED** for creative visual design. Marketing and others have free hand, without control. **NO CDS Template Design** - no prescriptive component templates. **NO SaaS Typical Design Model** - no typical SaaS design patterns or templates.
* **IDE Creativity Markers:** Use `.vmp-creative`, `.vmp-marketing`, or `.vmp-free-form` classes to signal creative content. IDE will understand: Foundation rules do NOT apply, inline styles ENCOURAGED.
* **Engine:** Use **Nunjucks** syntax (`{% extends %}`, `{{ var }}`). Do not use EJS or Handlebars.
* **Production-Grade Only:** All implementations must be complete, functional, and production-ready. **NO stubs, NO placeholders, NO TODO comments, NO empty states, NO "dumb screens"** - Every screen must show real data or proper error messages.
* **Clarity Over Assumptions:** If requirements are unclear, ask for clarification. Never assume or guess implementation details.
* **Consistency Framework:** Follow `docs/development/AI_ASSISTANT_CONSISTENCY_PROTOCOL.md` for all work - no assumptions, standardized documentation, precise planning. This protocol enforces the Zero Assumption Rule and operational loop (Think-Plan-Act-Verify). Use existing logging, error boundaries, circuit breakers, and observability systems - do not introduce new concepts.
* **Mandatory Compliance Reporting:** After EVERY action, return diff summary and compliance percentage. Check file locations against `DOCUMENTATION_STANDARDS.md` (ONLY README.md in root). Calculate: `(compliant / total) * 100`. Fix violations immediately.
* **Zero Tech Debt:** Every implementation must follow established patterns, use proper error handling, and include necessary validations.
* **Clean Stack Baseline:** This repository is MORE advanced than most open-source VMP repos. Do NOT clone external repos. Fix current codebase. Focus on architecture patterns, not direct code reuse. See `ARCHITECTURE_ASSESSMENT_AND_RECOMMENDATIONS.md` for clean stack definition.
* **No Legacy Code:** Remove all `vmpAdapter` references. Use `nexusAdapter` only. No broken imports. No legacy routes. See migration path in architecture assessment.

---

## 2. üìÇ File System & Naming Conventions

### Directory Structure (Layer-Aligned)

| Type | Path | Layer | Description |
| --- | --- | --- | --- |
| **L0 Kernel** | `src/kernel/` | L0 | Concept Registry, Jurisdictional Value Sets, Canonical Identity Mapping |
| **L1 Domain** | `src/domains/` | L1 | Domain policy engines, Permission definitions, RBAC policies |
| **L2 Cluster** | `src/clusters/` | L2 | Operational workflows, Approval chains, State machines |
| **L3 Cell** | `src/views/pages/` | L3 | Full layouts extending `layout.html` (User-facing interfaces) |
| **L3 Cell** | `src/views/partials/` | L3 | HTMX fragments (cells). Standalone. |
| **Templates** | `src/views/templates/` | L3 | **READ-ONLY** boilerplate references. |

### Casing Standards (Strict Mapping)

The system uses **Kebab-Case** for URLs/Routes and **Snake_Case** for filenames.

| Context | Case Style | Example |
| --- | --- | --- |
| **Route URL** | `kebab-case` | `/partials/case-detail.html` |
| **File Name** | `snake_case` | `case_detail.html` |
| **Render Call** | `snake_case` | `res.render('partials/case_detail.html')` |

**‚ùå Incorrect:** `res.render('partials/case-detail.html')` (Will fail)  
**‚úÖ Correct:** `res.render('partials/case_detail.html')`

---

## 3. üõ†Ô∏è Code Patterns (Layer-Specific)

### A. L0 Kernel Implementation

**Constraint:** L0 features require Kernel Registry registration before implementation.

```javascript
// L0: Concept Registry Schema
// File: src/kernel/concept_registry.js
export const ConceptRegistry = {
  // Concepts must be registered here before use
  BANK: { id: 'concept_bank', version: 1 },
  CURRENCY: { id: 'concept_currency', version: 1 },
  COUNTERPARTY: { id: 'concept_counterparty', version: 1 }
};

// L0: Jurisdictional Value Set
// File: src/kernel/jurisdictional_values.js
export const JurisdictionalValueSets = {
  MALAYSIA_BANKS: {
    concept: ConceptRegistry.BANK,
    jurisdiction: 'MY',
    values: ['Bank Muamalat', 'Maybank', 'CIMB']
  }
};
```

### B. L1 Domain Policy Implementation

**Constraint:** L1 policies must derive from L0 concepts.

```javascript
// L1: Finance Domain Policy
// File: src/domains/finance/policy_engine.js
import { ConceptRegistry, JurisdictionalValueSets } from '../../kernel/index.js';

export class FinanceDomainPolicy {
  // Policy derives from L0 concept
  canUseBank(bankName, userId) {
    const bankConcept = ConceptRegistry.BANK;
    const validBanks = JurisdictionalValueSets.MALAYSIA_BANKS.values;
    // Policy logic here...
  }
}
```

### C. L2 Cluster Workflow Implementation

**Constraint:** L2 workflows must combine L1 domain policies.

```javascript
// L2: Payment Approval Workflow
// File: src/clusters/payments/approval_workflow.js
import { FinanceDomainPolicy } from '../../domains/finance/policy_engine.js';

export class PaymentApprovalWorkflow {
  constructor() {
    this.financePolicy = new FinanceDomainPolicy();
  }
  
  // Workflow combines L1 domain policies
  async approvePayment(paymentId, userId) {
    // Workflow logic using L1 policies...
  }
}
```

### D. L3 Cell Execution (Route Definition)

**Constraint:** Routes must be defined before the HTML file is created.

```javascript
// L3: User-facing route
// File: server.js
app.get('/case-dashboard', async (req, res) => {
    // Data fetching logic here...
    res.render('pages/case_dashboard.html', { 
        title: 'Dashboard',
        user: req.user 
    });
});

// L3: HTMX partial route
app.get('/partials/case-list.html', async (req, res) => {
    // Data fetching logic here...
    res.render('partials/case_list.html', { 
        items: data 
    });
});
```

### E. HTML Templates (Nunjucks) - L3 Only

**Constraint:** Use the provided boilerplate files as the starting point.

**Page Structure:**

```html
{% extends "layout.html" %}

{% block content %}
  <div class="vmp-container">
     <h1 class="vmp-h1">Page Title</h1>
     </div>
{% endblock %}
```

**Partial Structure (HTMX):**

```html
<div class="vmp-panel p-4" id="component-root">
  </div>
```

### F. HTMX Integration - L3 Only

**Constraint:** Always handle Loading and Empty states.

```html
<div hx-get="/partials/user-list.html" 
     hx-trigger="load" 
     hx-target="#target-id" 
     hx-indicator="#loading-id">
</div>

<div id="loading-id" class="htmx-indicator">
    <div class="vmp-spinner"></div> Loading...
</div>
```

---

## 4. üé® Design System (Contract-001) - L3 Only

**Constraint:** You are strictly bound to `public/globals.css` **ONLY for data presentation purposes**.

| Feature | Rule | Scope |
| --- | --- | --- |
| **Foundation Classes** | MUST use `.vmp-*` prefix for typography (`.vmp-h*`, `.vmp-body`, `.vmp-label`) | **Data presentation ONLY** |
| **Font Weight** | MUST be `300` (Light) for data presentation. Marketing exempt. | **Data presentation ONLY** |
| **Semantic Colors** | MUST use CSS vars (e.g., `var(--vmp-text)`, `var(--vmp-ok)`) for meaning in data presentation | **Data presentation ONLY** |
| **Spacing Tokens** | SHOULD use spacing scale (`var(--vmp-space-*)`) for data presentation consistency | **Data presentation ONLY** |
| **Design Layer** | **FREE HAND:** Inline styles, `<style>` blocks, custom components - **NO restrictions** | **Marketing & Creative** |
| **CDS Templates** | **FORBIDDEN:** No prescriptive component templates or design system templates | **All contexts** |
| **SaaS Design Model** | **FORBIDDEN:** No typical SaaS design patterns, templates, or prescriptive UI models | **All contexts** |
| **New CSS** | **FORBIDDEN** for Foundation Layer. Ask user if a token is missing. Design Layer can use any CSS. | **Foundation vs Design** |

---

## 5. ‚úÖ AI Workflow Checklist (Enhanced with Kernel Doctrine)

Before generating any code, the AI must verify:

1. [ ] **Kernel Doctrine Check:** Does this feature align with Kernel Doctrine L0-L3 model?
   - *If NO:* Stop. Review Kernel Doctrine and reassign feature to correct layer.

2. [ ] **L0 Concept Check:** Does this feature require L0 concept registration?
   - *If YES:* Stop. Register concept in L0 Kernel Registry first.

3. [ ] **Layer Assignment Check:** Is this feature assigned to the correct layer (L0-L3)?
   - *If UNCLEAR:* Stop. Ask for clarification.

4. [ ] **Priority Check:** Is this feature assigned correct priority (P0-P1-P2-P3)?
   - *If UNCLEAR:* Stop. Ask for clarification.

5. [ ] **Route Check:** Does `app.get('/target-route')` exist in `server.js`? (L3 only)
   - *If NO:* Stop. Create the route first.

6. [ ] **Naming Check:** Is the file `snake_case` and the route `kebab-case`?
7. [ ] **Location Check:** Is it in the correct layer directory (L0-L3)?
8. [ ] **Boilerplate Check:** Did I copy appropriate boilerplate for the layer?
9. [ ] **Context Check:** Is this data presentation or creative/marketing content? (L3 only)
   * *If Data Presentation:* Use VMP semantic classes (`.vmp-h*`, `.vmp-body`, `.vmp-label`)
   * *If Creative/Marketing:* Use `.vmp-creative`, `.vmp-marketing`, or `.vmp-free-form` marker, inline styles ENCOURAGED
10. [ ] **Production Check:** Is this implementation complete? No stubs, placeholders, or TODOs?
11. [ ] **Error Handling:** Are all error paths handled with proper error responses?
12. [ ] **Validation:** Are all inputs validated (required fields, data types, constraints)?
13. [ ] **Clarity Check:** Are all requirements clear? If not, ask for clarification before implementing.
14. [ ] **Pattern Compliance:** Does this follow established codebase patterns?
15. [ ] **Authority Check:** Does this feature respect layer authority hierarchy?

---

## 6. üö´ Strict Anti-Patterns (Layer-Enforced)

### L0 Anti-Patterns

* ‚ùå **NEVER** define business logic in L0 (belongs to L1-L2)
* ‚ùå **NEVER** define user interfaces in L0 (belongs to L3)
* ‚ùå **NEVER** define workflows in L0 (belongs to L2)
* ‚ùå **NEVER** create concepts without Kernel Registry registration
* ‚ùå **NEVER** modify canonical identity mappings (immutable)

### L1 Anti-Patterns

* ‚ùå **NEVER** define concepts in L1 (must exist in L0)
* ‚ùå **NEVER** define workflows in L1 (belongs to L2)
* ‚ùå **NEVER** define user interfaces in L1 (belongs to L3)
* ‚ùå **NEVER** bypass L0 concept registration

### L2 Anti-Patterns

* ‚ùå **NEVER** define concepts in L2 (must exist in L0)
* ‚ùå **NEVER** define domain policies in L2 (must exist in L1)
* ‚ùå **NEVER** define user interfaces in L2 (belongs to L3)

### L3 Anti-Patterns

* ‚ùå **NEVER** define business logic in L3 (derived from L0-L2)
* ‚ùå **NEVER** define concepts in L3 (must exist in L0)
* ‚ùå **NEVER** use `style="color: red"` in data presentation (Use `.vmp-text-danger`). ‚úÖ **ALLOWED** in creative/marketing content with `.vmp-creative` marker.
* ‚ùå **NEVER** create files in `src/views/` root (must be in subfolders).
* ‚ùå **NEVER** use CDS / Bootstrap / Tailwind classes without VMP wrappers in data presentation. ‚úÖ **ALLOWED** in creative/marketing content.
* ‚ùå **NEVER** write logic inside the HTML (keep it in `server.js` or adapters).
* ‚ùå **NEVER** leave a route returning 404 while creating the View.
* ‚ùå **NEVER** create stubs, placeholders, or incomplete implementations.
* ‚ùå **NEVER** use `TODO`, `FIXME`, `HACK`, or similar comments in production code.
* ‚ùå **NEVER** assume requirements - ask for clarification if unclear.
* ‚ùå **NEVER** skip error handling or validation.
* ‚ùå **NEVER** create code that requires future refactoring (tech debt).
* ‚ùå **NEVER** use Foundation Layer classes in creative/marketing content without creativity marker (`.vmp-creative`, `.vmp-marketing`, `.vmp-free-form`).

---

## 7. üè≠ Production-Grade Requirements (All Layers)

### 7.1 Complete Implementations

**Rule:** Every implementation must be fully functional and production-ready.

**Forbidden:**
```javascript
// ‚ùå BAD: Stub/placeholder
app.get('/invoices', (req, res) => {
  // TODO: Implement invoice list
  res.json({ message: 'Not implemented yet' });
});

// ‚ùå BAD: Incomplete error handling
app.get('/cases/:id', async (req, res) => {
  const case = await getCase(req.params.id);
  res.render('pages/case_detail.html', { case });
  // Missing: Error handling, validation, auth checks
});
```

**Required:**
```javascript
// ‚úÖ GOOD: Complete implementation
app.get('/invoices', async (req, res) => {
  try {
    const vendorId = req.user.vendorId;
    if (!vendorId) {
      return res.status(401).render('pages/error.html', {
        error: { status: 401, message: 'Authentication required' }
      });
    }
    
    const invoices = await nexusAdapter.getInvoices(vendorId);
    res.render('pages/invoices.html', { invoices, user: req.user });
  } catch (error) {
    logError(error, { path: req.path, userId: req.user?.id });
    res.status(500).render('pages/error.html', {
      error: { status: 500, message: 'Failed to load invoices' }
    });
  }
});
```

### 7.2 Error Handling

**Rule:** All routes must handle errors gracefully with proper status codes and user-friendly messages.

**Required Patterns:**
- Try-catch blocks for async operations
- Input validation before processing
- Proper HTTP status codes (400, 401, 403, 404, 500)
- Error logging with context
- User-friendly error pages/messages

### 7.3 Input Validation (ENFORCED)

**Rule:** All user inputs MUST be validated with ENFORCED rules. Validation is not optional - it is mandatory.

**ENFORCED Validation Rules (Non-Negotiable):**

**Email Validation:**
- ‚úÖ **MUST contain "@" character** - Reject if missing
- ‚úÖ **MUST have text before "@"** - Reject if empty
- ‚úÖ **MUST have text after "@"** - Reject if empty
- ‚úÖ **MUST contain "." after "@"** - Reject if missing
- ‚úÖ **MUST have text after final "."** - Reject if empty
- ‚ùå **NO exceptions** - Invalid email = 400 Bad Request

**UUID Validation:**
- ‚úÖ **MUST match UUID v4 format** - Reject if invalid
- ‚úÖ **MUST be exactly 36 characters** - Reject if wrong length
- ‚ùå **NO exceptions** - Invalid UUID = 400 Bad Request

**Required Fields:**
- ‚úÖ **MUST be present** - Reject if missing
- ‚úÖ **MUST not be empty string** - Reject if empty
- ‚úÖ **MUST not be null** - Reject if null
- ‚ùå **NO exceptions** - Missing required field = 400 Bad Request

**Data Type Validation:**
- ‚úÖ **MUST match expected type** - Reject if type mismatch
- ‚úÖ **Numbers MUST be numeric** - Reject if NaN
- ‚úÖ **Strings MUST be strings** - Reject if not string
- ‚úÖ **Booleans MUST be boolean** - Reject if not boolean
- ‚ùå **NO exceptions** - Type mismatch = 400 Bad Request

**Constraint Validation:**
- ‚úÖ **String length MUST be within limits** - Reject if too short/long
- ‚úÖ **Number range MUST be valid** - Reject if out of range
- ‚úÖ **Enum values MUST be from allowed set** - Reject if not in set
- ‚ùå **NO exceptions** - Constraint violation = 400 Bad Request

**Implementation Requirement:**
```javascript
// ‚úÖ REQUIRED: Enforced validation
function validateEmail(email) {
  if (!email || typeof email !== 'string') {
    throw new ValidationError('Email is required and must be a string');
  }
  if (!email.includes('@')) {
    throw new ValidationError('Email must contain "@" character');
  }
  const [local, domain] = email.split('@');
  if (!local || !domain) {
    throw new ValidationError('Email must have text before and after "@"');
  }
  if (!domain.includes('.')) {
    throw new ValidationError('Email domain must contain "."');
  }
  const parts = domain.split('.');
  if (!parts[parts.length - 1]) {
    throw new ValidationError('Email must have text after final "."');
  }
  return true;
}
```

### 7.4 Authentication & Authorization

**Rule:** All protected routes must verify authentication and authorization.

**Required:**
- Check `req.user` exists (authentication)
- Verify user has access to requested resource (authorization)
- RBAC checks for internal-only routes (`req.user.isInternal`)
- Vendor access checks (vendor can only access their own data)
- **L1 Domain Policy checks** (who may use which L0 values)

### 7.5 Database Operations (Supabase MCP Only)

**Rule:** All database operations MUST be handled by Supabase MCP. Do NOT write database code in `.cursorrules` or routes.

**CRITICAL:**
- ‚úÖ **Use Supabase MCP** - All PostgreSQL operations via MCP
- ‚úÖ **Reference Supabase MCP documentation** - `docs/integrations/supabase/SUPABASE_MCP_*.md`
- ‚úÖ **Let Supabase MCP build, leverage, optimize PostgreSQL** - MCP is the agent
- ‚ùå **NO direct Supabase client calls in routes** - Use adapter layer that calls MCP
- ‚ùå **NO database schema definitions in code** - MCP handles schema
- ‚ùå **NO SQL queries in routes** - MCP handles queries
- ‚ùå **NO database optimization in code** - MCP handles optimization

**Implementation Pattern:**
```javascript
// ‚úÖ CORRECT: Use adapter that calls Supabase MCP
// File: src/adapters/nexus-adapter.js
async getData(id) {
  // Adapter calls Supabase MCP (not direct Supabase client)
  // MCP handles all PostgreSQL operations
  return await supabaseMCP.getData(id);
}

// ‚ùå WRONG: Direct Supabase calls
async getData(id) {
  const { data } = await supabase.from('table').select('*').eq('id', id);
  return data;
}
```

**Documentation Reference:**
- See `docs/integrations/supabase/SUPABASE_MCP_GUIDE.md`
- See `docs/integrations/supabase/SUPABASE_MCP_SETUP.md`
- See `docs/integrations/supabase/SUPABASE_MCP_QUICK_START.md`

### 7.6 Code Clarity

**Rule:** If requirements are unclear, ask for clarification before implementing.

**When to Ask:**
- Business logic is ambiguous
- Data structure is unclear
- User flow is not specified
- Integration requirements are vague
- Edge cases are not defined
- Template structure is unclear
- Pre-seeded pattern doesn't exist

**Never:**
- Assume implementation details
- Create placeholder code
- Guess at requirements
- Leave unclear code with comments
- Deviate from template structure
- Create features without templates

---

## 8. üîç Code Review Checklist (Layer-Aware)

Before submitting any code, verify:

- [ ] **Template Compliance:** Feature uses existing template/pre-seed
- [ ] **Template Structure:** Feature follows template structure exactly
- [ ] **Pre-Seed Check:** Feature matches pre-seeded patterns
- [ ] **No Empty States:** All screens show real data or proper empty state UI
- [ ] **Complete:** No stubs, placeholders, or TODOs
- [ ] **Error Handling:** All error paths handled
- [ ] **Validation:** All inputs validated
- [ ] **Auth:** Authentication and authorization checks present
- [ ] **Patterns:** Follows established codebase patterns
- [ ] **Naming:** Correct casing (snake_case files, kebab-case URLs)
- [ ] **Design System:** Uses only VMP classes (L3 only)
- [ ] **Testing:** Code is testable and maintainable
- [ ] **Documentation:** Complex logic is commented
- [ ] **Performance:** No obvious performance issues

---

## 9. üìã Implementation Standards (Template-Based)

### 9.1 Template-Based Development

**Required Process:**
1. **Find Template:** Look in `src/views/templates/` or `docs/development/templates/`
2. **Copy Template:** Use template as starting point
3. **Follow Structure:** Do not deviate from template structure
4. **Fill in Details:** Replace template placeholders with actual implementation

**Template Locations:**
- **L0 (Kernel):** `src/kernel/templates/` - Concept Registry, Value Sets
- **L1 (Domain):** `src/domains/templates/` - Policy engines, Permissions
- **L2 (Cluster):** `src/clusters/templates/` - Workflows, Approval chains
- **L3 (Cell):** `src/views/templates/` - User interfaces, Routes

**If Template Doesn't Exist:**
- STOP implementation
- Request template creation
- Wait for template approval
- Then proceed with template

### 9.2 Route Implementation (L3 - Template-Based)

**Required Structure:**
```javascript
// L3: User-facing route
app.get('/route-path', async (req, res) => {
  try {
    // 1. Authentication check
    if (!req.user) {
      return res.status(401).redirect('/login');
    }
    
    // 2. Input validation
    const { param } = req.params;
    if (!param || !isValidUUID(param)) {
      return res.status(400).render('pages/error.html', {
        error: { status: 400, message: 'Invalid parameter' }
      });
    }
    
    // 3. Authorization check (L1 Domain Policy)
    if (!financePolicy.canUseBank(bankName, req.user.id)) {
      return res.status(403).render('pages/error.html', {
        error: { status: 403, message: 'Access denied' }
      });
    }
    
    // 4. Business logic (L2 Cluster Workflow)
    const data = await paymentWorkflow.getPayment(param, req.user.vendorId);
    
    // 5. Render response (L3 Cell Execution)
    res.render('pages/template.html', { data, user: req.user });
  } catch (error) {
    // 6. Error handling
    logError(error, { path: req.path, userId: req.user?.id });
    res.status(500).render('pages/error.html', {
      error: { status: 500, message: 'An error occurred' }
    });
  }
});
```

### 9.5 Adapter Methods (Supabase MCP Pattern)

**Required Structure:**
```javascript
// Adapter layer (used by L1-L3)
// MUST use Supabase MCP, not direct Supabase client
async getData(id, vendorId) {
  // Adapter calls Supabase MCP
  // MCP handles all PostgreSQL operations, optimization, and error handling
  return await supabaseMCP.getData('table', { id, vendor_id: vendorId });
}

// Error handling is done by MCP
// Timeout protection is done by MCP
// Query optimization is done by MCP
// All database concerns handled by MCP
```

### 9.6 HTML Templates (L3 Only)

**Required Structure:**
```html
{% extends "layout.html" %}

{% block content %}
<div class="vmp-container">
  {% if error %}
    <div class="vmp-panel vmp-text-danger">
      {{ error.message }}
    </div>
  {% else %}
    <!-- Complete, functional UI -->
    <div class="vmp-panel">
      <!-- No placeholders, all data rendered -->
    </div>
  {% endif %}
</div>
{% endblock %}
```

---

## 10. üö´ Forbidden Patterns (All Layers)

### 10.1 Template Violations

```javascript
// ‚ùå FORBIDDEN: Creating feature without template
// File: src/domains/finance/policy_engine.js
export class FinanceDomainPolicy {
  // No template used - WRONG
}

// ‚úÖ REQUIRED: Use template first
// Step 1: Find template in src/domains/templates/policy_engine_template.js
// Step 2: Copy template structure
// Step 3: Fill in implementation details
// File: src/domains/finance/policy_engine.js
import { PolicyEngineTemplate } from '../templates/policy_engine_template.js';

export class FinanceDomainPolicy extends PolicyEngineTemplate {
  // Follows template structure exactly
}
```

### 10.2 Stubs, Placeholders, and Empty States (FORBIDDEN)

```javascript
// ‚ùå FORBIDDEN: Stub/placeholder
app.get('/route', (req, res) => {
  // TODO: Implement this
  res.json({ status: 'coming soon' });
});

// ‚ùå FORBIDDEN: Placeholder data
app.get('/route', (req, res) => {
  res.render('pages/template.html', { 
    data: null, // Placeholder
    message: 'Not implemented'
  });
});

// ‚ùå FORBIDDEN: Empty state without proper handling
app.get('/route', (req, res) => {
  const items = [];
  res.render('pages/template.html', { items }); // Empty array = "dumb screen"
});

// ‚úÖ REQUIRED: Proper empty state with context
app.get('/route', async (req, res) => {
  const items = await getItems();
  if (items.length === 0) {
    res.render('pages/template.html', { 
      items: [],
      emptyState: {
        title: 'No items found',
        message: 'Items will appear here when available',
        action: { label: 'Create Item', href: '/items/create' }
      }
    });
  } else {
    res.render('pages/template.html', { items });
  }
});
```

**Empty State Rules:**
- ‚ùå **NO empty arrays without context** - Always provide empty state message
- ‚ùå **NO "No data" without explanation** - Explain why it's empty
- ‚ùå **NO blank screens** - Always show something meaningful
- ‚úÖ **MUST provide empty state UI** - Title, message, and optional action
- ‚úÖ **MUST explain why empty** - User should understand the state

### 10.3 Assumptions

```javascript
// ‚ùå FORBIDDEN: Assuming data structure
const invoice = await getInvoice(id);
res.render('template.html', { 
  amount: invoice.total // What if invoice.total doesn't exist?
});

// ‚úÖ REQUIRED: Validate and handle
const invoice = await getInvoice(id);
if (!invoice) {
  return res.status(404).render('pages/error.html', {
    error: { status: 404, message: 'Invoice not found' }
  });
}
res.render('template.html', { 
  amount: invoice.total || 0 // Safe default
});
```

### 10.4 Incomplete Error Handling

```javascript
// ‚ùå FORBIDDEN
app.get('/route', async (req, res) => {
  const data = await getData(); // No error handling
  res.render('template.html', { data });
});

// ‚úÖ REQUIRED
app.get('/route', async (req, res) => {
  try {
    const data = await getData();
    res.render('template.html', { data });
  } catch (error) {
    logError(error);
    res.status(500).render('pages/error.html', {
      error: { status: 500, message: 'Operation failed' }
    });
  }
});
```

---

## 11. üìö Reference Documents

### Kernel Doctrine (Absolute Authority)
- **[NEXUS_CANON_V5_KERNEL_DOCTRINE.md](docs/ssot/db/NEXUS_CANON_V5_KERNEL_DOCTRINE.md)** - Business Operating Constitution

### SSOT Documents
- **[DB_GUARDRAIL_MATRIX.md](docs/ssot/db/DB_GUARDRAIL_MATRIX.md)** - Operational SSOT matrix
- **[JSONB_CONTRACT_REGISTRY.md](docs/ssot/db/JSONB_CONTRACT_REGISTRY.md)** - JSONB contract definitions
- **[RLS_COVERAGE.md](docs/ssot/db/RLS_COVERAGE.md)** - Row-level security policies

### Development Guides
- **[AI_ASSISTANT_CONSISTENCY_PROTOCOL.md](docs/development/AI_ASSISTANT_CONSISTENCY_PROTOCOL.md)** - Consistency framework
- **[PRD_CONSOLIDATION_STRATEGY.md](docs/development/prds/PRD_CONSOLIDATION_STRATEGY.md)** - PRD alignment with Kernel Doctrine

### Architecture
- **[ARCHITECTURE_ASSESSMENT_AND_RECOMMENDATIONS.md](docs/architecture/ARCHITECTURE_ASSESSMENT_AND_RECOMMENDATIONS.md)** - Clean stack definition

---

**Document Status:** ‚úÖ Kernel Doctrine Aligned  
**Last Updated:** 2025-01-22  
**Version:** 4.0.0  
**Authority:** Derived from [NEXUS_CANON_V5_KERNEL_DOCTRINE.md](docs/ssot/db/NEXUS_CANON_V5_KERNEL_DOCTRINE.md)
